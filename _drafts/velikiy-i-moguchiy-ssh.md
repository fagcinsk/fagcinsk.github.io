---
layout: post
categories: linux
title: Великий и могучий SSH на удалёнке
description: Множество способов облегчить себе жизнь работая на удалёнке и вообще
---

Начать работать удалённо можно в последнюю пятницу перед карантином пока ещё никто не готов.
Кто-то не желает переводить сотрудников на удалённую работу, кто-то не умеет или боится этого.
А дядя Миша уже всё сделал. =)

## Первая попытка настроить удалённый доступ

К тому времени у меня уже давно имелся домашний сервер с доступом по SSH. Очень удобно проворачивать всякие штуки.
Например обеспечивал [постоянный доступ к Termux через ssh тоннель](/blog/android/persistent-termux-access-through-ssh-tunnel).

Начинать всегда стоит с [быстрого способа создать и залить SSH ключ на сервер](/blog/linux/zalit-ssh-klyuch-na-server).

Как это сделали, возващаемся к посту про [постоянный доступ к Termux через ssh тоннель](/blog/android/persistent-termux-access-through-ssh-tunnel), только на этот раз делаем то же самое на рабочей машине.

Чтобы предусмотреть потерю соединения из-за отключения сети или других причин, советую поставить autossh в автозагрузку при старте системы или поднятию сети любым удобным для вас способом.
В своём Arch Linux добавил в systemd сервис:

```
[Unit]
Description=AutoSSH service for a reverse tunnel
After=network.target

[Service]
ExecStart=/usr/bin/autossh -M 0 -q -N -o "ServerAliveInterval 60" -o "ServerAliveCountMax 3" myserver

[Install]
WantedBy=multi-user.target
```

Таким образом, autossh будет запущен после поднятия сети. Флаг `-M 0` говорит о том что я не хочу использовать дополнительный порт для проверки живости соединения.
Пускай об этом позаботится ssh (`ServerAliveInterval`, `ServerAliveCountMax`). Далее указан алиас `myserver`, который ранее определяли в `~/.ssh/config`.

Далее произведём тестовый запуск службы:
```
sudo systemctl start autossh.service
```,
если не было ошибок, добавим службу в автозапуск:
```
sudo systemctl start autossh.service
```.

Ещё советую протестировать соединение через наш обратный (reverse) SSH тоннель и поставить на выполнение что-то простое типа: `watch ps`. Это предотвратит "залипание" соединения. Такое происходит когда соединение установлено, а пакетов нет. И как понял, такое случается по специфике работы NAT: он убирает связь между хостами, а соединение об этом ничего не знает.

Сделав вышеопиванное был доволен как слон собственнонастроенному удалённому доступу к рабочей машине.

Однако, что-то пошло не так и примерно через неделю соединение отвалилось.
Пришлось доставать админа, чтобы получить доступ к внутренней сети хоть каким-нибудь способом. На помощь опять же пришёл SSH!

## Настраиваем проброс портов через промежуточный сервер

